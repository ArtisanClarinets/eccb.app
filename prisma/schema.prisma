generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  emailVerified     Boolean            @default(false)
  name              String?
  image             String?
  password          String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  deletedAt         DateTime?
  twoFactorEnabled  Boolean            @default(false)
  role              String?
  banned            Boolean            @default(false)
  banReason         String?
  banExpires        DateTime?
  announcements     Announcement[]
  auditLogs         AuditLog[]
  emailLogs         EmailLog[]
  member            Member?
  notifications     UserNotification[]
  customPermissions UserPermission[]
  roles             UserRole[]
  accounts          Account[]
  sessions          Session[]
  annotations       Annotation[]
  userPreferences   UserPreferences?

  @@index([email])
  @@index([deletedAt])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "account_userId_fkey")
  @@map("account")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "session_userId_fkey")
  @@map("session")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verification")
}

model Role {
  id          String           @id @default(cuid())
  name        String           @unique
  displayName String
  description String?
  type        RoleType
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  permissions RolePermission[]
  users       UserRole[]

  @@index([type])
}

model UserRole {
  id         String    @id @default(cuid())
  userId     String
  roleId     String
  assignedAt DateTime  @default(now())
  assignedBy String?
  expiresAt  DateTime?
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  resource        String
  action          String
  scope           String?
  description     String?
  createdAt       DateTime         @default(now())
  roles           RolePermission[]
  userPermissions UserPermission[]

  @@index([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  roleId       String
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  grantedAt    DateTime   @default(now())
  grantedBy    String?
  expiresAt    DateTime?
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
}

model Member {
  id               String             @id @default(cuid())
  userId           String?            @unique
  firstName        String
  lastName         String
  email            String?
  phone            String?
  profilePhoto     String?
  status           MemberStatus       @default(PENDING)
  joinDate         DateTime?
  leaveDate        DateTime?
  emergencyName    String?
  emergencyPhone   String?
  emergencyEmail   String?
  notes            String?
  isSubstitute     Boolean            @default(false)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  deletedAt        DateTime?
  attendance       Attendance[]
  user             User?              @relation(fields: [userId], references: [id])
  instruments      MemberInstrument[]
  sections         MemberSection[]
  musicAssignments MusicAssignment[]
  carpoolEntries   CarpoolEntry[]
  sectionMessages  SectionMessage[]

  @@index([status])
  @@index([lastName, firstName])
  @@index([deletedAt])
}

model Instrument {
  id         String             @id @default(cuid())
  name       String             @unique
  family     String
  sortOrder  Int                @default(0)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  members    MemberInstrument[]
  musicParts MusicPart[]

  @@index([family])
  @@index([sortOrder])
}

model MemberInstrument {
  id           String     @id @default(cuid())
  memberId     String
  instrumentId String
  isPrimary    Boolean    @default(false)
  instrument   Instrument @relation(fields: [instrumentId], references: [id])
  member       Member     @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([memberId, instrumentId])
  @@index([memberId])
  @@index([instrumentId])
}

// ====================================
// Section Board
// ====================================

model SectionMessage {
  id         String   @id @default(cuid())
  sectionId  String
  memberId   String
  content    String   @db.LongText
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  section    Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@index([sectionId])
  @@index([memberId])
  @@index([createdAt])
}

model Section {
  id          String          @id @default(cuid())
  name        String          @unique
  description String?
  sortOrder   Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  members     MemberSection[]
  messages    SectionMessage[]
  annotations Annotation[]

  @@index([sortOrder])
}

model MemberSection {
  id         String   @id @default(cuid())
  memberId   String
  sectionId  String
  isLeader   Boolean  @default(false)
  assignedAt DateTime @default(now())
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  section    Section  @relation(fields: [sectionId], references: [id])

  @@unique([memberId, sectionId])
  @@index([memberId])
  @@index([sectionId])
}

model MusicPiece {
  id                 String            @id @default(cuid())
  title              String
  subtitle           String?
  composerId         String?
  arrangerId         String?
  publisherId        String?
  difficulty         MusicDifficulty?
  duration           Int?
  genre              String?
  style              String?
  instrumentation    String?
  tags               String?           @db.LongText
  catalogNumber      String?           @unique
  notes              String?
  performanceHistory String?
  isArchived         Boolean           @default(false)
  confidenceScore    Int?
  source            String?
  ensembleType       String?
  keySignature       String?
  timeSignature      String?
  tempo              String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  deletedAt          DateTime?
  eventMusic         EventMusic[]
  assignments        MusicAssignment[]
  files              MusicFile[]
  parts              MusicPart[]
  arranger           Person?           @relation("ArrangerPieces", fields: [arrangerId], references: [id])
  composer           Person?           @relation("ComposerPieces", fields: [composerId], references: [id])
  publisher          Publisher?        @relation(fields: [publisherId], references: [id])
  annotations        Annotation[]
  navigationLinksFrom NavigationLink[] @relation("NavigationLinksFrom")
  navigationLinksTo   NavigationLink[] @relation("NavigationLinksTo")
  audioLinks        AudioLink[]

  @@index([title])
  @@index([composerId])
  @@index([difficulty])
  @@index([isArchived])
  @@index([deletedAt])
  @@index([arrangerId], map: "MusicPiece_arrangerId_fkey")
  @@index([publisherId], map: "MusicPiece_publisherId_fkey")
}

model MusicFile {
  id                String             @id @default(cuid())
  pieceId           String
  fileName          String
  fileType          FileType
  fileSize          Int
  mimeType          String
  storageKey        String
  storageUrl        String?
  version           Int                @default(1)
  description       String?
  isPublic          Boolean            @default(false)
  isArchived        Boolean            @default(false)
  uploadedAt        DateTime           @default(now())
  uploadedBy        String?
  contentHash       String?
  extractedMetadata String?            @db.LongText
  ocrText           String?            @db.Text
  originalUploadId  String?
  source            String?
  pageCount         Int?
  partLabel         String?
  instrumentName    String?
  section           String?
  partNumber        Int?
  downloads         FileDownload[]
  piece             MusicPiece         @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  versions          MusicFileVersion[]
  parts             MusicPart[]

  @@index([pieceId])
  @@index([fileType])
}

model MusicFileVersion {
  id         String    @id @default(cuid())
  fileId     String
  version    Int
  fileName   String
  storageKey String
  fileSize   Int
  mimeType   String
  changeNote String?
  uploadedAt DateTime  @default(now())
  uploadedBy String?
  file       MusicFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@unique([fileId, version])
  @@index([fileId])
  @@index([uploadedAt])
}

// ====================================
// Smart Upload Session
// ====================================

enum SmartUploadStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
}

model SmartUploadSession {
  id                 String           @id @default(cuid())
  uploadSessionId    String           @unique
  fileName           String
  fileSize           Int
  mimeType           String
  storageKey         String
  extractedMetadata  Json?
  confidenceScore    Int?
  status             SmartUploadStatus @default(PENDING_REVIEW)
  uploadedBy         String
  reviewedBy         String?
  reviewedAt         DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  parsedParts        Json?
  parseStatus        String?
  secondPassStatus   String?
  secondPassResult   Json?
  autoApproved       Boolean          @default(false)
  routingDecision    String?
  cuttingInstructions Json?
  llmProvider        String?
  llmVisionModel     String?
  llmVerifyModel     String?
  llmModelParams     Json?
  llmPromptVersion   String?
  tempFiles          Json?
  firstPassRaw       String?          @db.LongText
  secondPassRaw      String?          @db.LongText

  @@index([uploadSessionId])
  @@index([status])
  @@index([uploadedBy])
}

model MusicPart {
  id           String     @id @default(cuid())
  pieceId      String
  instrumentId String
  partName     String
  fileId       String?
  isOptional   Boolean    @default(false)
  notes        String?
  section      String?
  partNumber   Int?
  partLabel    String?
  transposition String?
  pageCount    Int?
  storageKey   String?
  file         MusicFile? @relation(fields: [fileId], references: [id])
  instrument   Instrument @relation(fields: [instrumentId], references: [id])
  piece        MusicPiece @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([pieceId])
  @@index([instrumentId])
  @@index([fileId], map: "MusicPart_fileId_fkey")
}

model Person {
  id             String       @id @default(cuid())
  firstName      String
  lastName       String
  fullName       String
  bio            String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  arrangedPieces MusicPiece[] @relation("ArrangerPieces")
  composedPieces MusicPiece[] @relation("ComposerPieces")

  @@index([lastName, firstName])
}

model Publisher {
  id          String       @id @default(cuid())
  name        String       @unique
  website     String?
  contactInfo String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  pieces      MusicPiece[]

  @@index([name])
}

model MusicAssignment {
  id           String                   @id @default(cuid())
  pieceId      String
  memberId     String
  partName     String?
  partId       String?
  copyNumber   Int?
  priority     Int?
  notes        String?
  status       AssignmentStatus         @default(ASSIGNED)
  assignedAt   DateTime                 @default(now())
  assignedBy   String?
  pickedUpAt   DateTime?
  pickedUpBy   String?
  dueDate      DateTime?
  returnedAt   DateTime?
  returnedTo   String?
  condition    String?
  missingSince DateTime?
  missingNotes String?
  member       Member                   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  piece        MusicPiece               @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  history      MusicAssignmentHistory[]

  @@index([pieceId])
  @@index([memberId])
  @@index([dueDate])
  @@index([status])
}

model MusicAssignmentHistory {
  id           String           @id @default(cuid())
  assignmentId String
  action       String
  fromStatus   String?
  toStatus     String?
  notes        String?
  performedBy  String
  performedAt  DateTime        @default(now())
  assignment   MusicAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([assignmentId])
  @@index([performedAt])
}

model FileDownload {
  id               String    @id @default(cuid())
  fileId           String
  userId           String?
  downloadedAt     DateTime  @default(now())
  ipAddress        String?
  userAgent        String?
  bytesTransferred Int?
  file             MusicFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@index([fileId])
  @@index([userId])
  @@index([downloadedAt])
}

// ====================================
// Carpool
// ====================================

enum CarpoolType {
  OFFER
  REQUEST
}

model CarpoolEntry {
  id         String      @id @default(cuid())
  eventId    String
  memberId   String
  type       CarpoolType
  seats      Int?
  location   String?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  
  event   Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member  Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)
  
  @@unique([eventId, memberId])
  @@index([eventId])
  @@index([memberId])
}

// ====================================
// Event Models
// ====================================

model Event {
  id           String       @id @default(cuid())
  title        String
  description  String?
  type         EventType
  startTime    DateTime
  endTime      DateTime
  location     String?
  venueId      String?
  callTime     DateTime?
  dressCode    String?
  programOrder String?      @db.LongText
  isCancelled  Boolean      @default(false)
  isPublished  Boolean      @default(false)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?
  attendance   Attendance[]
  venue        Venue?       @relation(fields: [venueId], references: [id])
  music        EventMusic[]
  notes        EventNote[]
  carpoolEntries CarpoolEntry[]

  @@index([type])
  @@index([startTime])
  @@index([isPublished])
  @@index([deletedAt])
  @@index([venueId], map: "Event_venueId_fkey")
}

model Venue {
  id         String   @id @default(cuid())
  name       String
  address    String?
  city       String?
  state      String?
  zipCode    String?
  directions String?
  parking    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  events     Event[]

  @@index([name])
}

model Attendance {
  id       String           @id @default(cuid())
  eventId  String
  memberId String
  status   AttendanceStatus
  notes    String?
  markedAt DateTime         @default(now())
  markedBy String?
  event    Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  member   Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@unique([eventId, memberId])
  @@index([eventId])
  @@index([memberId])
  @@index([status])
}

model EventMusic {
  id        String     @id @default(cuid())
  eventId   String
  pieceId   String
  sortOrder Int        @default(0)
  notes     String?
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  piece     MusicPiece @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@unique([eventId, pieceId])
  @@index([eventId])
  @@index([pieceId])
}

model EventNote {
  id            String   @id @default(cuid())
  eventId       String
  title         String?
  content       String
  isPublic      Boolean  @default(false)
  targetSection String?
  createdAt     DateTime @default(now())
  createdBy     String?
  updatedAt     DateTime @updatedAt
  event         Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

model Page {
  id              String        @id @default(cuid())
  title           String
  slug            String        @unique
  description     String?
  content         String        @db.LongText
  rawMarkdown     String?
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?       @db.LongText
  ogImage         String?
  status          ContentStatus @default(DRAFT)
  publishedAt     DateTime?
  scheduledFor    DateTime?
  version         Int           @default(1)
  parentVersionId String?
  createdAt       DateTime      @default(now())
  createdBy       String?
  updatedAt       DateTime      @updatedAt
  updatedBy       String?
  deletedAt       DateTime?
  versions        PageVersion[]

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
}

model PageVersion {
  id        String   @id @default(cuid())
  pageId    String
  version   Int
  content   String   @db.LongText
  createdAt DateTime @default(now())
  createdBy String?
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)

  @@unique([pageId, version])
  @@index([pageId])
}

model Announcement {
  id            String               @id @default(cuid())
  title         String
  content       String
  type          AnnouncementType     @default(INFO)
  audience      AnnouncementAudience @default(ALL)
  targetRoles   String?              @db.LongText
  isUrgent      Boolean              @default(false)
  isPinned      Boolean              @default(false)
  status        ContentStatus        @default(DRAFT)
  publishAt     DateTime?
  publishedAt   DateTime?
  expiresAt     DateTime?
  createdAt     DateTime             @default(now())
  createdBy     String?
  updatedAt     DateTime             @updatedAt
  author        User?                @relation(fields: [createdBy], references: [id])
  notifications UserNotification[]

  @@index([status])
  @@index([publishAt])
  @@index([publishedAt])
  @@index([expiresAt])
  @@index([isPinned])
  @@index([createdBy], map: "Announcement_createdBy_fkey")
}

model MediaAsset {
  id         String   @id @default(cuid())
  fileName   String
  fileSize   Int
  mimeType   String
  storageKey String
  storageUrl String?
  title      String?
  altText    String?
  caption    String?
  tags       String?  @db.LongText
  width      Int?
  height     Int?
  uploadedAt DateTime @default(now())
  uploadedBy String?

  @@index([mimeType])
  @@index([uploadedAt])
}

model EmailTemplate {
  id          String            @id @default(cuid())
  name        String            @unique
  type        EmailTemplateType @default(CUSTOM)
  subject     String
  body        String
  textBody    String?
  description String?
  variables   String?           @db.LongText
  isActive    Boolean           @default(true)
  isDefault   Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  createdBy   String?

  @@index([type])
  @@index([isActive])
}

model UserNotification {
  id             String           @id @default(cuid())
  userId         String
  type           NotificationType
  title          String
  message        String
  linkUrl        String?
  linkText       String?
  announcementId String?
  eventId        String?
  isRead         Boolean          @default(false)
  readAt         DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime?
  updatedBy      String?
  announcement   Announcement?    @relation(fields: [announcementId], references: [id])
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([announcementId], map: "UserNotification_announcementId_fkey")
}

model Message {
  id         String   @id @default(cuid())
  subject    String
  body       String
  senderId   String
  senderName String
  recipients String   @db.LongText
  sentAt     DateTime @default(now())

  @@index([senderId])
  @@index([sentAt])
}

model EmailLog {
  id             String      @id @default(cuid())
  subject        String
  body           String
  recipientCount Int
  recipientType  String
  status         EmailStatus @default(PENDING)
  sentById       String?
  sentAt         DateTime?
  errorMessage   String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime?
  updatedBy      String?
  sentBy         User?       @relation(fields: [sentById], references: [id])

  @@index([sentById])
  @@index([status])
  @@index([createdAt])
}

model SystemSetting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?

  @@index([key])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  userName   String?
  ipAddress  String?
  userAgent  String?
  action     String
  entityType String
  entityId   String?
  oldValues  String?  @db.LongText
  newValues  String?  @db.LongText
  timestamp  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
}

model AIModel {
  id                                                       String            @id
  providerId                                               String
  modelId                                                  String
  displayName                                              String
  description                                              String?
  supportsVision                                           Boolean           @default(false)
  supportsStructuredOutput                                 Boolean           @default(false)
  supportsStreaming                                        Boolean           @default(false)
  maxTokens                                                Int?
  contextWindow                                            Int?
  lastFetched                                              DateTime?
  isAvailable                                              Boolean           @default(true)
  isDefault                                                Boolean           @default(false)
  isPreferred                                              Boolean           @default(false)
  createdAt                                                DateTime          @default(now())
  updatedAt                                                DateTime
  AIProvider                                               AIProvider        @relation(fields: [providerId], references: [id], onDelete: Cascade)
  ModelParameter                                           ModelParameter[]
  TaskModelConfig_TaskModelConfig_fallbackModelIdToAIModel TaskModelConfig[] @relation("TaskModelConfig_fallbackModelIdToAIModel")
  TaskModelConfig_TaskModelConfig_modelIdToAIModel         TaskModelConfig[] @relation("TaskModelConfig_modelIdToAIModel")

  @@unique([providerId, modelId])
  @@index([isDefault])
  @@index([isPreferred])
  @@index([providerId])
}

model AIProvider {
  id                                                             String            @id
  providerId                                                     String            @unique
  displayName                                                    String
  description                                                    String?
  baseUrl                                                        String?
  logoUrl                                                        String?
  isEnabled                                                      Boolean           @default(false)
  isDefault                                                      Boolean           @default(false)
  sortOrder                                                      Int               @default(0)
  capabilities                                                   String?           @db.LongText
  createdAt                                                      DateTime          @default(now())
  updatedAt                                                      DateTime
  AIModel                                                        AIModel[]
  APIKey                                                         APIKey[]
  TaskModelConfig_TaskModelConfig_fallbackProviderIdToAIProvider TaskModelConfig[] @relation("TaskModelConfig_fallbackProviderIdToAIProvider")
  TaskModelConfig_TaskModelConfig_primaryProviderIdToAIProvider  TaskModelConfig[] @relation("TaskModelConfig_primaryProviderIdToAIProvider")

  @@index([isEnabled])
  @@index([sortOrder])
}

model APIKey {
  id              String     @id
  providerId      String
  keyName         String?
  encryptedKey    String     @db.Text
  keyHash         String
  isValid         Boolean    @default(false)
  validationError String?
  lastValidated   DateTime?
  expiresAt       DateTime?
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime
  createdBy       String?
  AIProvider      AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([providerId])
}

model ModelParameter {
  id              String   @id
  modelId         String
  name            String
  displayName     String
  description     String?
  paramType       String
  defaultValue    Float?
  minValue        Float?
  maxValue        Float?
  stringDefault   String?
  allowedValues   String?  @db.LongText
  userValue       Float?
  userStringValue String?
  isAdvanced      Boolean  @default(false)
  isVisible       Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  AIModel         AIModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)

  @@unique([modelId, name])
  @@index([modelId])
}

model SettingsAuditLog {
  id         String   @id
  entityType String
  entityId   String
  action     String
  fieldName  String?
  oldValue   String?
  newValue   String?
  changedBy  String?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@index([changedBy])
  @@index([entityType, entityId])
  @@index([timestamp])
}

model SmartUploadBatch {
  id                  String                        @id
  userId              String
  status              SmartUploadBatch_status       @default(CREATED)
  currentStep         SmartUploadBatch_currentStep?
  totalFiles          Int                           @default(0)
  processedFiles      Int                           @default(0)
  successFiles        Int                           @default(0)
  failedFiles         Int                           @default(0)
  createdAt           DateTime                      @default(now())
  updatedAt           DateTime
  completedAt         DateTime?
  errorSummary        String?
  SmartUploadItem     SmartUploadItem[]
  SmartUploadProposal SmartUploadProposal[]

  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model SmartUploadItem {
  id                  String                       @id
  batchId             String
  fileName            String
  fileSize            Int
  mimeType            String
  storageKey          String?
  status              SmartUploadItem_status       @default(CREATED)
  currentStep         SmartUploadItem_currentStep?
  errorMessage        String?
  errorDetails        String?                      @db.LongText
  ocrText             String?                      @db.Text
  extractedMeta       String?                      @db.LongText
  isPacket            Boolean                      @default(false)
  splitPages          Int?
  splitFiles          String?                      @db.LongText
  createdAt           DateTime                     @default(now())
  updatedAt           DateTime
  completedAt         DateTime?
  SmartUploadBatch    SmartUploadBatch             @relation(fields: [batchId], references: [id], onDelete: Cascade)
  SmartUploadProposal SmartUploadProposal[]

  @@index([batchId])
  @@index([status])
}

model SmartUploadProposal {
  id                   String           @id
  itemId               String
  batchId              String
  title                String?
  composer             String?
  arranger             String?
  publisher            String?
  difficulty           String?
  genre                String?
  style                String?
  instrumentation      String?
  duration             Int?
  notes                String?
  titleConfidence      Float?
  composerConfidence   Float?
  difficultyConfidence Float?
  isApproved           Boolean          @default(false)
  approvedAt           DateTime?
  approvedBy           String?
  corrections          String?          @db.LongText
  matchedPieceId       String?
  isNewPiece           Boolean          @default(true)
  createdAt            DateTime         @default(now())
  updatedAt            DateTime
  SmartUploadBatch     SmartUploadBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  SmartUploadItem      SmartUploadItem  @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@index([batchId])
  @@index([isApproved])
  @@index([itemId])
}

model SmartUploadSetting {
  id          String   @id
  key         String   @unique
  value       String
  description String?
  category    String   @default("general")
  isPublic    Boolean  @default(false)
  updatedAt   DateTime
  updatedBy   String?

  @@index([category])
  @@index([key])
}

// ====================================
// Stand Features - Digital Music Stand
// ====================================

model Annotation {
  id         String          @id @default(cuid())
  musicId    String
  page       Int
  layer      AnnotationLayer
  strokeData Json
  userId     String
  sectionId  String?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  music      MusicPiece      @relation(fields: [musicId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id])
  section    Section?        @relation(fields: [sectionId], references: [id])

  @@index([musicId])
  @@index([userId])
  @@index([layer])
  @@index([sectionId])
}

enum AnnotationLayer {
  PERSONAL
  SECTION
  DIRECTOR
}

model NavigationLink {
  id        String     @id @default(cuid())
  musicId   String
  fromPage  Int        @default(1)
  fromX     Float
  fromY     Float
  toPage    Int        @default(1)
  toMusicId String?
  toX       Float
  toY       Float
  label     String?
  createdAt DateTime   @default(now())
  music     MusicPiece @relation("NavigationLinksFrom", fields: [musicId], references: [id], onDelete: Cascade)
  toMusic   MusicPiece? @relation("NavigationLinksTo", fields: [toMusicId], references: [id])

  @@index([musicId])
  @@index([toMusicId])
}

model StandSession {
  id         String   @id @default(cuid())
  eventId    String
  userId     String
  section    String?
  lastSeenAt DateTime @default(now())
  createdAt  DateTime @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
}

model AudioLink {
  id          String     @id @default(cuid())
  pieceId     String
  fileKey     String
  url         String?
  description String?
  createdAt   DateTime   @default(now())
  piece       MusicPiece @relation(fields: [pieceId], references: [id], onDelete: Cascade)

  @@index([pieceId])
}

model UserPreferences {
  id                String   @id @default(cuid())
  userId            String   @unique
  nightMode         Boolean  @default(false)
  metronomeSettings Json?
  midiMappings      Json?
  otherSettings     Json?
  updatedAt         DateTime @updatedAt
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model TaskModelConfig {
  id                                                        String                   @id
  taskType                                                  TaskModelConfig_taskType @unique
  modelId                                                   String?
  temperature                                               Float?
  maxTokens                                                 Int?
  topP                                                      Float?
  createdAt                                                 DateTime                 @default(now())
  updatedAt                                                 DateTime
  fallbackModelId                                           String?
  fallbackProviderId                                        String?
  primaryProviderId                                         String?
  AIModel_TaskModelConfig_fallbackModelIdToAIModel          AIModel?                 @relation("TaskModelConfig_fallbackModelIdToAIModel", fields: [fallbackModelId], references: [id])
  AIProvider_TaskModelConfig_fallbackProviderIdToAIProvider AIProvider?              @relation("TaskModelConfig_fallbackProviderIdToAIProvider", fields: [fallbackProviderId], references: [id])
  AIModel_TaskModelConfig_modelIdToAIModel                  AIModel?                 @relation("TaskModelConfig_modelIdToAIModel", fields: [modelId], references: [id])
  AIProvider_TaskModelConfig_primaryProviderIdToAIProvider  AIProvider?              @relation("TaskModelConfig_primaryProviderIdToAIProvider", fields: [primaryProviderId], references: [id])

  @@index([fallbackModelId])
  @@index([fallbackProviderId])
  @@index([modelId])
  @@index([primaryProviderId])
  @@index([taskType])
}

enum RoleType {
  SUPER_ADMIN
  ADMIN
  DIRECTOR
  STAFF
  SECTION_LEADER
  LIBRARIAN
  MUSICIAN
  PUBLIC
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  LEAVE_OF_ABSENCE
  ALUMNI
  AUDITION
  PENDING
}

enum MusicDifficulty {
  GRADE_1
  GRADE_2
  GRADE_3
  GRADE_4
  GRADE_5
  GRADE_6
}

enum FileType {
  FULL_SCORE
  CONDUCTOR_SCORE
  PART
  CONDENSED_SCORE
  AUDIO
  LICENSING
  OTHER
}

enum AssignmentStatus {
  ASSIGNED
  PICKED_UP
  RETURNED
  OVERDUE
  LOST
  DAMAGED
}

enum EventType {
  CONCERT
  REHEARSAL
  SECTIONAL
  BOARD_MEETING
  SOCIAL
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  EXCUSED
  LATE
  LEFT_EARLY
}

enum ContentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum AnnouncementType {
  INFO
  WARNING
  URGENT
  EVENT
}

enum AnnouncementAudience {
  ALL
  MEMBERS
  ADMINS
}

enum EmailTemplateType {
  WELCOME
  PASSWORD_RESET
  EVENT_REMINDER
  ANNOUNCEMENT
  ATTENDANCE_SUMMARY
  CUSTOM
}

enum NotificationType {
  ANNOUNCEMENT
  EVENT_REMINDER
  MUSIC_ASSIGNMENT
  ATTENDANCE_REMINDER
  SYSTEM
}

enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum TaskModelConfig_taskType {
  METADATA_EXTRACTION
  AUDIO_ANALYSIS
  SUMMARIZATION
  TRANSCRIPTION
  CLASSIFICATION
}

enum SmartUploadBatch_status {
  CREATED
  UPLOADING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  INGESTING
  COMPLETE
  FAILED
  CANCELLED
}

enum SmartUploadBatch_currentStep {
  VALIDATED
  TEXT_EXTRACTED
  METADATA_EXTRACTED
  SPLIT_PLANNED
  SPLIT_COMPLETE
  INGESTED
}

enum SmartUploadItem_status {
  CREATED
  UPLOADING
  PROCESSING
  NEEDS_REVIEW
  APPROVED
  INGESTING
  COMPLETE
  FAILED
  CANCELLED
}

enum SmartUploadItem_currentStep {
  VALIDATED
  TEXT_EXTRACTED
  METADATA_EXTRACTED
  SPLIT_PLANNED
  SPLIT_COMPLETE
  INGESTED
}
