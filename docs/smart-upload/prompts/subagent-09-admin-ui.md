## Prompt Title

Phase 9 – Admin UI Alignment

## Role

You are a front‑end engineer with expertise in Next.js App Router, React, and Tailwind.

## Objective

Update the admin UI pages and components related to Smart Upload to reflect new backend capabilities: truthful status displays, provider capability metadata, settings form dynamic behavior, review/exceptions UX, and preview features. Ensure every UI element matches the canonical state model and provide reactive feedback for background processing.

## Context

The current UI pages (`/admin/uploads`, `/admin/uploads/review`, `/admin/uploads/settings`) are functional but use outdated assumptions (string statuses, static provider list, limited exception filtering). After backend refactor phases, the UI must show new statuses, enable one‑click second-pass requeue, display fingerprint/duplicate warnings, indicate provider capabilities, and provide safe preview links. Settings form must bind to the new schema and validation logic from Phase 7.

## Verified Files to Review

- `src/app/(admin)/admin/uploads/page.tsx`
- `src/app/(admin)/admin/uploads/review/page.tsx`
- `src/app/(admin)/admin/uploads/settings/page.tsx`
- `src/components/admin/music/smart-upload-settings-form.tsx`
- Sidebar component for navigation if necessary.
- Any UI test files or storybook stories.

## Files to Modify

- Update table columns and filters on uploads page to include new enum states, `requiresHumanReview` badges, fingerprint collisions, and routingDecision indicators.
- In review page, show parsedParts thumbnails, allow inline edits of metadata (title, composer, instruments), add "Re-run second pass" button for failed sessions, and display provider info.
- Modify settings form component to:
   - Dynamically show/hide API key and endpoint fields based on provider selection.
   - Display model dropdowns populated by `/api/admin/uploads/models` calls.
   - Show capability badges (Vision, Verification, Adjudication) for selected provider/model.
   - Validate using `SmartUploadSettingsSchema` (reuse from backend via shared types or import directly) and show error messages.
- Add a new UI route or modal for viewing raw LLM prompts/responses for debugging (optional, but helpful for manual review).
- Ensure preview routes are used to render PDF images; show fallback if unavailable.

## Files to Create

- New React component `SmartUploadSessionRow` for reuse between list and review.
- New UI tests for settings form and review page.

## Technical Requirements

1. **Type Safety:** Import enums from `src/types/smart-upload` and use them for component props and conditional rendering.
2. **Accessibility:** Maintain WCAG compliance; all new buttons must have ARIA labels and keyboard focus handling.
3. **State Updates:** Use SWR or React Query to pull session status and events; implement polling or SSE for progress updates.
4. **Error Handling:** Display user-friendly errors for failed API calls, including permission errors and network issues.
5. **Provider Display:** When settings form selects a provider, fetch capability info and show a small table or list of supported features.
6. **Exception UX:** On uploads/review pages, highlight sessions marked `requiresHumanReview` or `COMMIT_FAILED` with red accents and an icon. Provide a filter toggle "Show only exceptions".

## Required Constraints

- Do not add heavy new dependencies; use existing UI libraries (Radix/Headless components already in repo).
- Avoid large bundle size increases; code-split heavy components (e.g. PDF preview) using `dynamic()` imports.

## Edge Cases to Handle

- UI should gracefully handle stale sessions (deleted or updated by background process). Display "Session not found" or refresh automatically.
- Settings form must properly handle server‑side rendering on Next.js when loading provider lists.
- Disconnect scenarios when model listing API returns errors – the form should show placeholder options and an error message but not crash.

## Required Verification

- **DoD Compliance:** Verify that your changes align with the overarching goals of a complete, enterprise-level autonomous system defined in `docs/smart-upload/smart-upload.DoD.md` and `smart-upload.DoD.acceptance-criteria.md`.
- **Zero Warnings/Errors:** You must run all tests, linting (`npm run lint`), typechecking (`npx tsc --noEmit` or `npm run build`), and Next.js build. Do not complete this phase until **ALL** warnings and errors generated by any of these tools have been completely resolved.

- Write Jest/Vitest component tests for settings form logic and review page state transitions.
- Use Playwright to simulate uploading a fixture, opening admin review, editing metadata, triggering second pass, and approving. Capture screenshots.
- Run `npm run lint` and `npm run test` to ensure UI components are covered.

## Expected Deliverables

- Updated UI pages and components as described.
- New tests and any necessary stories/documentation.
- Updated navigation if required.

## Stop Conditions

Stop if updating UI requires backend API not yet implemented by prior phases; coordinate with orchestrator to adjust ordering.
