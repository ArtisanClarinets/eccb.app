## Prompt Title

Phaseâ€¯10 â€“ Tests, Fixtures, CI, and Production Hardening

## Role

You are a QA engineer and DevOps specialist with deep experience writing automated tests and configuring CI pipelines.

## Objective

Expand test coverage to guarantee end-to-end autonomous ingest, add robust fixtures, update CI workflow to include new tests and migration checks, and harden production readiness (documentation, environment variables, deployment steps).

## Context

Previous phases added new functionality across many modules. Existing tests mostly cover unit behaviors but there is insufficient integration/e2e coverage to validate a full autonomous upload. There are no fixtures for scanned PDFs, ambiguous pages, corrupt files, duplicates, or large documents. CI may not run migrations or ensure schema and types remain in sync. Environment configuration and deployment docs may be outdated.

## Verified Files to Review

- Existing tests under `src/app/api/files/smart-upload/__tests__` and `src/lib/jobs/__tests__`
- Fixture directories and sample PDF files
- `.github/workflows/` for CI definitions, particularly if smart-upload tests are mentioned
- `env.example` and any deployment docs under `docs/` (LOCAL_SETUP.md, DEPLOYMENT.md)

## Files to Modify

- Add new unit tests in `src/lib/*/__tests__` for all services (see Phaseâ€¯4 and ðŸŽ¯). Ensure each service also has negative tests.
- Add integration tests in `src/app/api/files/smart-upload/__tests__` that run through the entire pipeline using mocks for LLM or using real local Ollama if available. Include scenarios for normal PDF, scanned PDF, duplicate upload, parse failure, second-pass errors, auto-commit, and manual review.
- Create e2e tests using Playwright or Vitest + `mcp_next-devtools_browser_eval` to simulate a user uploading a PDF from Admin UI and verifying resulting library entries.
- Add fixtures in a new `src/app/api/files/smart-upload/__tests__/fixtures` directory: `scanned.pdf`, `ambiguous.pdf`, `duplicate1.pdf`, `duplicate2.pdf`, `corrupt.pdf`, `large.pdf` (can be generated by script or use placeholders/simple content). Add code to tests to load these fixtures.
- Update CI workflow `.github/workflows/ci.yaml` (or similar) to run: `npm run lint`, `npm run test` (including new tests), `npx prisma migrate deploy --preview-feature` to catch migration errors, and `npm run build`. Add caching for node modules.
- Ensure CI pipeline fails if TypeScript type-check errors are present (`tsc --noEmit`).
- Add environment variable checks early in app startup to ensure required keys (e.g. storage config, LLM credentials) are present; add tests to mock missing envs.
- Update `env.example` with all new smart-upload settings keys and documentation comments. Update `DEPLOYMENT.md` with steps to run migrations and configure Redis, the OCR queue, and provider-specific variables.

## Files to Create

- New fixture generation script (e.g. `scripts/generate-pdf-fixtures.ts`).
- Add a CI helper script if necessary (e.g. `scripts/ci-validate.sh`).

## Technical Requirements

1. **Coverage Goals:** Aim for â‰¥ 90% coverage on all smart-upload related modules and â‰¥ 75% end-to-end coverage across the feature as reported by Vitest.
2. **Test Isolation:** Use mock implementations for LLM calls but allow switching to real networked provider via an environment flag (`USE_REAL_LLM=true`) for smoke tests.
3. **CI Safety:** Use a checkout action that caches `node_modules` and Prisma client. Ensure database migrations run against ephemeral test DB and do not modify production data.
4. **Performance:** Tests should complete within a reasonable time (<2 minutes) to keep CI fast; if fixture generation is heavy, cache artifacts.

## Required Constraints

- Do not commit large binary PDFs; keep fixtures small (<1â€¯MB) or generate them on-the-fly during tests.
- CI secrets must not be exposed in logs; mask keys.

## Edge Cases to Handle

- CI environment lacking certain native build tools required by `canvas` or `sharp`; use `npm rebuild` or add apt-get install steps in workflow.
- Test race conditions when running workers concurrently; isolate by using unique Redis DB numbers for each test and clean up after.

## Required Verification

- **DoD Compliance:** Verify that your changes align with the overarching goals of a complete, enterprise-level autonomous system defined in `docs/smart-upload/smart-upload.DoD.md` and `smart-upload.DoD.acceptance-criteria.md`.
- **Zero Warnings/Errors:** You must run all tests, linting (`npm run lint`), typechecking (`npx tsc --noEmit` or `npm run build`), and Next.js build. Do not complete this phase until **ALL** warnings and errors generated by any of these tools have been completely resolved.

- Execute the updated CI workflow locally (use act or similar) to ensure all steps succeed.
- Review coverage report generated by Vitest; confirm metrics.
- Run e2e tests against a fresh database and ensure they create and then tear down records without leaks.

## Expected Deliverables

- Additional test files and fixtures.
- Updated CI workflow YAML with new steps.
- Updated `env.example`, `DEPLOYMENT.md`, and new scripts as needed.

## Stop Conditions

Stop if adding comprehensive fixtures cannot be accomplished due to tooling limitations; discuss with orchestrator to simplify requirements.
