Research failing tests

Read [](file:///home/dylan/eccb.app/src/lib/services/__tests__/cutting-instructions.test.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/lib/services/__tests__/gap-detection.test.ts)

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/bootstrap.test.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/schema.test.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/__tests__/route.test.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/__tests__/route.test.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/lib/services/__tests__/cutting-instructions.test.ts#200-200), lines 200 to 585

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/bootstrap.test.ts#200-200), lines 200 to 614

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/schema.test.ts#200-200), lines 200 to 818

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/__tests__/route.test.ts#200-200), lines 200 to 240

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/__tests__/route.test.ts#200-200), lines 200 to 600

Searched for files matching `**/src/lib/services/cutting-instructions.ts`, 1 match

Read [](file:///home/dylan/eccb.app/src/lib/services/cutting-instructions.ts#1-1), lines 1 to 300

Searched for files matching `**/src/lib/smart-upload/bootstrap.ts`, 1 match

Searched for files matching `**/src/lib/smart-upload/schema.ts`, 1 match

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/route.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/route.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/__tests__/route.test.ts#600-600), lines 600 to 1015

Read [](file:///home/dylan/eccb.app/src/lib/services/cutting-instructions.ts#300-300), lines 300 to 523

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/bootstrap.ts#1-1), lines 1 to 300

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/schema.ts#1-1), lines 1 to 300

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/route.ts#200-200), lines 200 to 538

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/route.ts#200-200), lines 200 to 325

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/schema.ts#300-300), lines 300 to 422

Searched for files matching `**/src/app/api/admin/uploads/settings/reset-prompts/route.ts`, 1 match

Searched for files matching `**/src/app/api/admin/uploads/settings/test/route.ts`, 1 match

Searched for text `splitOverlappingRanges|buildGapInstructions|providerRequiresApiKey|bootstrapSmartUploadSettings` (`**/src/**/*.ts`), 20 results

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/reset-prompts/route.ts)

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/test/route.ts#1-1), lines 1 to 200

Read [](file:///home/dylan/.vscode-server/data/User/workspaceStorage/c1d5f6895d8fa41635301c9c0352286c/GitHub.copilot-chat/chat-session-resources/4906ef1f-c86b-412f-b88e-bfedb134a7b4/toolu_bdrk_01XdpfTQvYQ3mvmJfHLerwbp__vscode-1772136144153/content.txt)

Now I have everything needed for a precise plan. 

Read source files for plan

Read [](file:///home/dylan/eccb.app/src/lib/services/cutting-instructions.ts#420-420), lines 420 to 510

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/schema.ts#220-220), lines 220 to 250

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/bootstrap.ts#1-1), lines 1 to 80

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/bootstrap.test.ts#240-240), lines 240 to 290

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/__tests__/route.test.ts#1-1), lines 1 to 120

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/route.ts#1-1), lines 1 to 120

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/test/route.ts)

Read [](file:///home/dylan/eccb.app/src/app/api/admin/uploads/settings/__tests__/route.test.ts#780-780), lines 780 to 950

Read [](file:///home/dylan/.vscode-server/data/User/workspaceStorage/c1d5f6895d8fa41635301c9c0352286c/GitHub.copilot-chat/chat-session-resources/4906ef1f-c86b-412f-b88e-bfedb134a7b4/toolu_bdrk_01JsVidHpnrMMdsWKgjCgPrj__vscode-1772136144184/content.txt#1-1), lines 1 to 400

Read [](file:///home/dylan/.vscode-server/data/User/workspaceStorage/c1d5f6895d8fa41635301c9c0352286c/GitHub.copilot-chat/chat-session-resources/4906ef1f-c86b-412f-b88e-bfedb134a7b4/toolu_bdrk_01JsVidHpnrMMdsWKgjCgPrj__vscode-1772136144184/content.txt#400-400), lines 400 to 700

Read [](file:///home/dylan/.vscode-server/data/User/workspaceStorage/c1d5f6895d8fa41635301c9c0352286c/GitHub.copilot-chat/chat-session-resources/4906ef1f-c86b-412f-b88e-bfedb134a7b4/toolu_bdrk_01JsVidHpnrMMdsWKgjCgPrj__vscode-1772136144184/content.txt#700-700), lines 700 to 927

Now let me check the bootstrap failing test and the omr failing test more precisely: 

Find bootstrap failing test

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/bootstrap.test.ts#120-120), lines 120 to 200

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/__tests__/route.test.ts#120-120), lines 120 to 230

Read [](file:///home/dylan/eccb.app/src/lib/services/__tests__/cutting-instructions.test.ts#380-380), lines 380 to 470

Read [](file:///home/dylan/eccb.app/src/lib/services/__tests__/gap-detection.test.ts)

Read [](file:///home/dylan/eccb.app/src/app/api/stand/omr/__tests__/route.test.ts#230-230), lines 230 to 240

Searched for text `should return empty actions when all settings exist` (`**/src/lib/smart-upload/__tests__/bootstrap.test.ts`), 1 result

Read [](file:///home/dylan/eccb.app/src/lib/smart-upload/__tests__/bootstrap.test.ts#260-260), lines 260 to 340

Read [](file:///home/dylan/.vscode-server/data/User/workspaceStorage/c1d5f6895d8fa41635301c9c0352286c/GitHub.copilot-chat/chat-session-resources/4906ef1f-c86b-412f-b88e-bfedb134a7b4/toolu_bdrk_0179Cdf7Y5mjsm8fQ93dTa2t__vscode-1772136144196/content.txt#1-1), lines 1 to 400

Now I have full context. Here is the complete implementation plan:

---

## Plan: Fix 18 Pre-existing Test Failures

All 18 failures fall into 6 groups. 11 require source code fixes; 7 require test fixes (correcting wrong mock field names or missing mock data). Each change is surgically scoped.

---

**Steps**

### Group 1 — `splitOverlappingRanges` leaks internal `originalIndex` field (4 failures)

**Source:** cutting-instructions.ts

Root cause: `.map((inst, originalIndex) => ({ ...inst, originalIndex }))` at line 442 stamps every item with an `originalIndex` integer. That field is spread into the result array via `result.push({ ...current })` and `result.push({ ...current, pageEnd: adjustedEnd })` at lines 457 and 465 — so the returned objects contain `originalIndex` that tests never expect.

**Fix (source only):** Before every `result.push(...)` call, destructure `originalIndex` away:

```
const { originalIndex: _oi, ...clean } = current;
result.push({ ...clean, pageEnd: adjustedEnd });   // overlap branch
// and:
result.push({ ...clean });   // no-overlap branch
```

This is a 4-line change to lines 457-466. No test changes needed.

---

### Group 2 — `buildGapInstructions` uses 0-indexed internals; tests provide 1-indexed ranges (6 failures)

**Source:** cutting-instructions.ts  
**Tests:** gap-detection.test.ts

Root cause: The source iterates `for (let p = 0; p < totalPages; p++)` (0-indexed). The test helper `makeInst(1, 10)` passes page 1 meaning "first page" and page 10 meaning "last page" — standard 1-indexed music notation. Because the source treats `pageRange[0]=1` as the *second* slot (index 1), page 0 is always uncovered, producing phantom gaps. Gap labels also add `+1` which double-offsets the display strings.

**Fix (source only):**

1. Change the coverage loop at line 497 — no change needed here (it builds from inst ranges directly).
2. Change the gap-scan loop at line 503: `for (let p = 0; p < totalPages; p++)` → `for (let p = 1; p <= totalPages; p++)`
3. Change the trailing-gap flush (currently line ~511 area, where `gapStart !== null` after the loop): `gaps.push([gapStart, p - 1])` → `gaps.push([gapStart, totalPages])`  
4. Update the label format — currently `Unlabelled Pages ${gapStart + 1}-${end + 1}` → `Unlabelled Pages ${gapStart}-${end}` (input is now already 1-indexed so no offset needed)
5. Update the docstring to say "expects **1-indexed** page ranges"

Read lines 490–540 of the source before editing to confirm exact current form of these three locations.

---

### Group 3 — `bootstrapSmartUploadSettings` has 3 settings the "all settings exist" test doesn't mock (1 failure)

**Test:** bootstrap.test.ts

Root cause: `DEFAULT_NUMERIC_SETTINGS` in bootstrap.ts contains:
- `smart_upload_skip_parse_threshold: '60'`
- `smart_upload_enable_autonomous_mode: 'false'`
- `smart_upload_autonomous_approval_threshold: '95'`

The test mock at lines 293–311 provides 17 rows but omits these 3. `bootstrapSmartUploadSettings` finds them missing and pushes 3 actions, so `expect(result.actions).toHaveLength(0)` fails (actual length is 3).

**Fix (test only):** Add 3 rows to the `mockResolvedValue` array in that test:
```
{ key: 'smart_upload_skip_parse_threshold', value: '60' },
{ key: 'smart_upload_enable_autonomous_mode', value: 'false' },
{ key: 'smart_upload_autonomous_approval_threshold', value: '95' },
```

---

### Group 4 — `providerRequiresApiKey('custom')` returns `false` but test expects `true` (1 failure)

**Source:** schema.ts

Root cause: Line 232: `return provider !== 'ollama' && provider !== 'custom';` — explicitly excludes `custom`. The test and the `test/route.ts` spec both treat custom providers as requiring an API key.

**Fix (source only):** Remove `&& provider !== 'custom'`:
```
return provider !== 'ollama';
```

Cascade check: The only production use of `providerRequiresApiKey('custom')` is in `validateProviderApiKey` (schema.ts line ~249) and `bootstrap.ts`. With the fix, the `custom` provider will now pass through key-validation logic. Verify no other call site produces a regression by running `grep -n "providerRequiresApiKey" src/**/*.ts`.

---

### Group 5 — OMR route test: wrong mock field names + missing `arrayBuffer` mock (1 failure)

**Test:** route.test.ts

Root cause: `mockMusicFile` at line 56 uses `fileKey` and `musicPieceId`. The route's Prisma select (route.ts lines 80–84) fetches `storageKey` and `pieceId`. The mismatch means `musicFile.storageKey` is `undefined` → `fileUrl` becomes `/api/files/undefined` → `fetchFileBuffer` calls `fetch(...)` → `res.arrayBuffer()` is undefined on the un-augmented mock → crash.

**Fix (test only), two parts:**

**Part A** — Rename mock fields at line 56–61:
```
const mockMusicFile = {
  id: 'file-123',
  storageKey: 'music/sheet.pdf',   // was: fileKey
  extractedMetadata: null,
  pieceId: 'piece-123',            // was: musicPieceId
};
```

**Part B** — In the "should process OMR when forceReprocess is true" test (~line 204), the route makes **two** sequential `fetch` calls: (1) to retrieve the PDF file (needs `arrayBuffer()`), (2) to the OpenAI API (needs `json()`). Replace the single `mockResolvedValue` with two chained `mockResolvedValueOnce` calls:
```
vi.mocked(global.fetch)
  .mockResolvedValueOnce({
    ok: true,
    arrayBuffer: () => Promise.resolve(new ArrayBuffer(100)),
  } as unknown as Response)
  .mockResolvedValueOnce({
    ok: true,
    json: () => Promise.resolve({
      choices: [{
        message: {
          content: JSON.stringify({ tempo: 140, keySignature: 'G major', timeSignature: '4/4' }),
        },
      }],
    }),
  } as Response);
```

Before implementing Part B: read route.ts lines 100–200 to verify the `performOMRAnalysis` / `fetchFileBuffer` call order and confirm the fetch call count is exactly 2.

---

### Group 6 — `uploads/settings/test/route.ts` — 5 source behaviour mismatches (5 failures)

**Source:** route.ts  
**Tests:** route.test.ts

**Fix 6a — "Connection failed" prefix on non-ok responses** (test line 797):

The test asserts `data.error.toContain('Connection failed')`. Source line 171 returns `"Server responded with ${response.status}${hint}"`. Change to:
```
error: `Connection failed: Server responded with ${response.status}${hint}`,
```

**Fix 6b — API key required for cloud providers** (test line 844):

The test sends `provider: 'openai'` with no `apiKey` and expects status `400` with `"API key is required"`. Source currently skips the header when `apiKey` is falsy but never rejects.

After `const { provider, endpoint, apiKey, model } = parsed.data;` (line 52), add validation before the switch:
```
const cloudProviders = ['openai', 'anthropic', 'gemini', 'openrouter'] as const;
if ((cloudProviders as readonly string[]).includes(provider) && !apiKey) {
  return NextResponse.json(
    { ok: false, error: 'API key is required for this provider.' },
    { status: 400 }
  );
}
```

**Fix 6c — "Endpoint URL is required" message for custom provider** (test line 863):

Test expects `.toContain('Endpoint URL is required')`. Source line 130 returns `'Custom base URL is required.'`. Change to:
```
{ ok: false, error: 'Endpoint URL is required for the custom provider.' },
```

**Fix 6d — AbortError → "timed out" for Ollama** (test line 905):

The Ollama loop catch at line 88 currently formats as `lastError = \`${url} → ${e.message}\``. Test expects the final error to contain `'timed out'`. Change to:
```
lastError = e instanceof Error && e.name === 'AbortError'
  ? `${url} → Connection timed out`
  : `${url} → ${e instanceof Error ? e.message : String(e)}`;
```
The returned string `"Could not reach Ollama. Last error: ... → Connection timed out"` then satisfies `.toContain('timed out')`.

**Fix 6e — Add `auditLog` call** (test line 939):

Before implementing: read [src/app/api/admin/uploads/settings/__tests__/route.test.ts](src/app/api/admin/uploads/settings/__tests__/route.test.ts#L1) lines 1–60 to find `mockAuditLog`'s module path (the `vi.mock(...)` declaration for it). Then:

1. Add the import of `auditLog` from that same module to [src/app/api/admin/uploads/settings/test/route.ts](src/app/api/admin/uploads/settings/test/route.ts#L1)
2. Add the call immediately before the final `return NextResponse.json({ ok: true, message: ... })` at line 176 — but **after** the route knows the result is a success:
```
await auditLog({
  action: 'TEST_LLM_CONNECTION',
  entityType: 'SETTING',
  entityId: 'smart_upload',
  newValues: { provider, model, success: true },
});
```
Note: for Ollama (which returns early inline), `auditLog` must also be called on success in that case block. Read the Ollama success path at line 81 and add the call there too.

---

**Verification**

After all changes:
```bash
# TypeScript check — must still be 0 errors
npx tsc --noEmit

# ESLint — must still be 0 issues  
npm run lint

# Run only the 6 formerly-failing test files
npx vitest run \
  cutting-instructions.test.ts \
  gap-detection.test.ts \
  bootstrap.test.ts \
  schema.test.ts \
  route.test.ts \
  route.test.ts

# Full suite — should be 0 failures
npx vitest run
```

Expected final state: `Tests 0 failed | 1379+ passed`.

---

**Decisions**
- Groups 1 & 2: Fix source (not tests) — the tests correctly reflect intended API contract (1-indexed music pages, clean return objects)
- Groups 3 & 5: Fix tests — the source is correct; mocks were never updated when source gained new fields/settings
- Group 4: Fix source — `custom` is a user-configured external endpoint requiring auth; treating it like Ollama (no key needed) was wrong per spec
- Group 6: Fix source — all 5 mismatches represent spec requirements that were never implemented in the test routeExpected final state: `Tests 0 failed | 1379+ passed`.

---

reload
- Groups 1 & 2: Fix source (not tests) — the tests correctly reflect intended API contract (1-indexed music pages, clean return objects)
- Groups 3 & 5: Fix tests — the source is correct; mocks were never updated when source gained new fields/settings
- Group 4: Fix source — `custom` is a user-configured external endpoint requiring auth; treating it like Ollama (no key needed) was wrong per spec
- Group 6: Fix source — all 5 mismatches represent spec requirements that were never implemented in the test route